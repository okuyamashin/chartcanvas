# 設計検討事項

## サイズ指定のアプローチ

### 採用方針: JavaScript側でサイズを指定

**決定:** `chart.size(width, height)`メソッドでサイズを指定する

### メリット

1. **SVGとコンテナのサイズを一致させやすい**
   - SVGの`width`/`height`属性とコンテナ要素のサイズを自動的に同期できる
   - サイズの不整合による表示の問題を回避できる

2. **プログラム的に制御しやすい**
   - 動的にサイズを変更できる
   - データに応じてサイズを調整しやすい

3. **シンプルなAPI**
   - CSSの知識が不要で、JavaScriptだけで完結する
   - ユーザーが迷わない

4. **SVG出力時のサイズが明確**
   - ダウンロードするSVGファイルのサイズが予測可能
   - 出力品質の一貫性が保てる

### デメリット（検討したが採用しない理由）

1. **CSSとの分離**
   - デザインとロジックが混在する
   - → SVG出力が主目的なので、このデメリットは許容範囲

2. **レスポンシブ対応**
   - 固定サイズになりがち
   - → SVG出力が主目的なので、固定サイズで問題ない

### Chart.jsとの違い

Chart.jsは要素のサイズに合わせてグラフを動的にリサイズしますが、ChartCanvasでは**この機能は不要**です。

**理由:**
1. **SVG出力が主目的**
   - SVGファイルとして出力するため、固定サイズで作成する方が合理的
   - 出力ファイルのサイズが予測可能で、品質が一貫する

2. **動的リサイズの必要性が低い**
   - Chart.jsのようなインタラクティブなダッシュボード用途ではない
   - ブラウザのウィンドウサイズに合わせてグラフを変形させる必要がない

3. **シンプルな実装**
   - リサイズイベントの監視や再計算が不要
   - パフォーマンスが良い

4. **出力品質の一貫性**
   - 同じデータから常に同じサイズのSVGが生成される
   - レイアウトやフォントサイズが一定で、見た目の一貫性が保てる

**結論:** 固定サイズで作成し、そのサイズでSVGを出力する設計が最適です。

### ユーザーの期待

**一般的に、グラフのサイズが動的に変わることは期待されていません。**

- グラフは通常、特定のサイズで作成・出力される
- レポートや資料に埋め込む際も、固定サイズであることが前提
- ブラウザのウィンドウサイズに合わせてグラフが変形するのは、むしろ不都合な場合が多い
- SVGファイルとして出力する場合、サイズが一定であることが重要

このため、ChartCanvasは**固定サイズ**で設計することが、ユーザーの期待に最も合致しています。

### 実装方針

```javascript
chart.size(1024, 600);
```

このメソッドは以下を実行：
1. コンテナ要素の`style.width`と`style.height`を設定（表示用）
2. 内部で保持するサイズ情報を更新（SVG生成用）
3. `render()`時に、このサイズでSVGを生成

**重要なポイント:**
- サイズは固定で、ブラウザのリサイズに追従しない
- SVGの`width`と`height`属性は、指定したサイズで固定される
- コンテナのサイズ変更イベントは監視しない（Chart.jsとは異なる）

### 代替案（検討したが採用しない）

#### 案1: CSSでサイズ指定
```css
#chart_div {
    width: 1024px;
    height: 600px;
}
```
- **問題点:** SVGのサイズとコンテナのサイズを別々に管理する必要がある

#### 案2: コンストラクタでサイズ指定
```javascript
new ChartCanvas(chart_div, { width: 1024, height: 600 });
```
- **問題点:** 後からサイズを変更できない

#### 案3: コンテナのサイズを自動検出
```javascript
// コンテナのサイズを読み取る
```
- **問題点:** コンテナにサイズが設定されていない場合に対応できない

## その他の設計検討事項

### デフォルトサイズ
- サイズを指定しない場合のデフォルト値は要検討
- 候補: `800x400`、`1024x600`、またはコンテナのサイズを読み取る

### サイズ変更のタイミング
- `render()`の前に`size()`を呼ぶ必要がある
- `render()`後に`size()`を呼んだ場合の挙動は要検討（再レンダリングが必要？）
- **ただし:** 通常は一度サイズを設定したら変更しない（グラフのサイズが動的に変わることは期待されていない）

### アスペクト比の維持
- オプションでアスペクト比を維持する機能は要検討
- 例: `chart.size(1024, 600).maintainAspectRatio(true)`
- **ただし:** SVG出力が主目的なので、固定サイズで十分な可能性が高い

### 動的リサイズ機能について

**決定:** 実装しない

- Chart.jsのような`responsive: true`オプションは不要
- ブラウザのリサイズイベントを監視しない
- サイズ変更が必要な場合は、ユーザーが明示的に`chart.size()`を呼び出す
- これにより、実装がシンプルになり、パフォーマンスも良い

### 円グラフのラベル位置の自動調整について

**Chart.jsの課題:**
- Chart.jsの円グラフは、ラベルの位置が手動設定になっており、自動的に調整できない
- ラベルが重なったり、読みにくい位置に配置されたりする問題がある

**本プロジェクトでの解決方針:**
- **ラベルの位置を自動的に調整する**（必須機能）
- ラベルが重なる場合、自動的に位置を調整して重なりを回避
- ユーザーが手動で位置を設定する必要がない
- これにより、Chart.jsの課題を解決する

**実装方針:**
1. 各セグメントのラベルの位置を計算
2. **180度付近（南）のラベルを特に注意してチェック**（重なりやすい）
3. ラベル同士が重なっているかチェック
4. 重なっている場合、位置を調整（角度を少しずらす、距離を調整するなど）
5. **小さいセグメントを「その他」カテゴリにまとめる（オプション）**
   - 350度付近（北西）に「その他」カテゴリを配置することを推奨
   - これにより、ラベルの数を減らし、見やすさが向上する
6. それでも重なる場合、優先度の低いラベルを非表示（凡例で確認可能）

**具体的な課題点への対処:**
- **180度付近（南）での文字の重なり:**
  - 180度付近のラベルは、特に注意して重なりを回避
  - ラベルの配置を少しずらす（角度を調整）
  - 引出線（リーダーライン）の長さを調整して、ラベルを離す

- **350度付近（北西）での「その他」カテゴリ:**
  - 小さいセグメントを「その他」カテゴリにまとめる機能を提供
  - 「その他」カテゴリは、350度付近（北西）に配置することを推奨
  - これにより、ラベルの数を減らし、見やすさが向上する

