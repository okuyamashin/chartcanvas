# ヒストグラムクリックイベント仕様

## 概要

ヒストグラムの棒をクリックしたときに、そのビンに含まれるデータの集合を取得し、指定されたコールバック関数に渡す機能を実装します。コールバック関数はJSONデータを受け取り、指定されたdiv要素にテーブルを表示します。

## 機能要件

### 1. テーブル表示用のdiv要素

ヒストグラム用のHTMLファイルに、テーブル表示用のdiv要素を追加します。

```html
<div id="data_table_div"></div>
```

**要件:**
- div要素のIDは任意（例: `data_table_div`）
- グラフの下に配置することを推奨
- 初期状態では空（または非表示）

### 2. コールバック関数の指定

ヒストグラムにコールバック関数を指定できるようにします。

```javascript
histogram.onBinClick = function(dataArray) {
    // dataArray: クリックされたビンに含まれるデータの配列
    // この関数内でテーブルを生成して表示
};
```

**データ形式:**
- `dataArray`: クリックされたビンに含まれる元のデータ値の配列
- 例: `[18000, 19500, 21000, 20500]`（ビン範囲が18000-20000の場合）

### 3. テーブル表示関数

コールバック関数内で、JSONデータを受け取ってテーブルを表示する関数を実装します。

```javascript
function displayDataTable(dataArray, containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container element not found: ${containerId}`);
        return;
    }
    
    // テーブルを生成
    const table = document.createElement('table');
    table.className = 'data-table';
    
    // ヘッダー行
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headerCell = document.createElement('th');
    headerCell.textContent = '値';
    headerRow.appendChild(headerCell);
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // データ行
    const tbody = document.createElement('tbody');
    dataArray.forEach(value => {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.textContent = value.toLocaleString(); // 数値フォーマット
        row.appendChild(cell);
        tbody.appendChild(row);
    });
    table.appendChild(tbody);
    
    // 既存のテーブルを削除して新しいテーブルを追加
    container.innerHTML = '';
    container.appendChild(table);
}
```

### 4. ヒストグラムのクリックイベント

ヒストグラムの棒をクリックしたときに、以下の処理を実行します：

1. クリックされた棒のビン範囲を特定
2. そのビン範囲に含まれる元のデータを取得
3. `onBinClick`コールバック関数が指定されている場合、データ配列を渡して呼び出し

**実装の詳細:**
- SVGの`<rect>`要素にクリックイベントリスナーを追加
- クリックされたビンの範囲（min, max）を取得
- 元のデータ配列から、その範囲に含まれるデータをフィルタリング
- フィルタリングされたデータ配列をコールバック関数に渡す

## API仕様

### HistogramChartクラス

#### プロパティ

##### `onBinClick` (Function, オプション)

ヒストグラムの棒をクリックしたときに呼び出されるコールバック関数を指定します。

**パラメータ:**
- `dataArray` (Array<number>): クリックされたビンに含まれる元のデータ値の配列

**戻り値:** なし

**例:**
```javascript
histogram.onBinClick = function(dataArray) {
    console.log('クリックされたビンのデータ:', dataArray);
    displayDataTable(dataArray, 'data_table_div');
};
```

### データの取得方法

ヒストグラムは、TSVローダーから読み込んだ元のデータを保持する必要があります。

**実装方針:**
- `HistogramSeries`クラスに`rawData`プロパティを追加
- TSVローダーでデータを読み込む際に、元のデータを`rawData`に保存
- ビンに分類する際に、各ビンに含まれる元のデータのインデックスも記録

## HTMLファイルの構造

### 基本構造

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ヒストグラムサンプル（クリックイベント付き）</title>
    <script src="../../chartcanvas.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #chart_div {
            border: 1px solid #ccc;
            margin: 20px 0;
        }
        #data_table_div {
            margin: 20px 0;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>ヒストグラムサンプル（クリックイベント付き）</h1>
    <p>ヒストグラムの棒をクリックすると、そのビンに含まれるデータがテーブルに表示されます。</p>
    
    <div id="chart_div"></div>
    <div id="data_table_div"></div>

    <script>
        // テーブル表示関数
        function displayDataTable(dataArray, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container element not found: ${containerId}`);
                return;
            }
            
            if (!dataArray || dataArray.length === 0) {
                container.innerHTML = '<p>データがありません。</p>';
                return;
            }
            
            // テーブルを生成
            const table = document.createElement('table');
            table.className = 'data-table';
            
            // ヘッダー行
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headerCell = document.createElement('th');
            headerCell.textContent = '値';
            headerRow.appendChild(headerCell);
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // データ行
            const tbody = document.createElement('tbody');
            dataArray.forEach(value => {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.textContent = value.toLocaleString(); // 数値フォーマット
                row.appendChild(cell);
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            
            // 統計情報を追加（オプション）
            const statsRow = document.createElement('tr');
            statsRow.className = 'stats-row';
            const statsCell = document.createElement('td');
            statsCell.colSpan = 1;
            const count = dataArray.length;
            const sum = dataArray.reduce((a, b) => a + b, 0);
            const avg = sum / count;
            statsCell.textContent = `件数: ${count}, 合計: ${sum.toLocaleString()}, 平均: ${avg.toLocaleString()}`;
            statsRow.appendChild(statsCell);
            tbody.appendChild(statsRow);
            
            // 既存のテーブルを削除して新しいテーブルを追加
            container.innerHTML = '';
            container.appendChild(table);
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const chart_div = document.getElementById('chart_div');
            const chart = new ChartCanvas(chart_div);
            chart.size(1024, 600);
            chart.title = '売上の分布';
            chart.subtitle = '全店舗の売上データ';

            const histogram = chart.addHistogram();
            histogram.xAxisTitle = '売上';
            histogram.yAxisTitle = '頻度';
            histogram.xAxisFormat = '#,##0';
            histogram.yAxisFormat = '#,##0';
            histogram.title = '売上の分布';
            histogram.subtitle = '全店舗の売上データ';

            // クリックイベントのコールバック関数を設定
            histogram.onBinClick = function(dataArray) {
                console.log('クリックされたビンのデータ:', dataArray);
                displayDataTable(dataArray, 'data_table_div');
            };

            // TSVローダーを使用してデータを読み込む
            const loader = histogram.tsvLoader('./data-histogram.tsv');
            loader.valueTitle = '値';

            try {
                await loader.load();
                chart.render();
            } catch (error) {
                console.error('TSVファイルの読み込みエラー:', error);
                chart.render();
            }
        });
    </script>
</body>
</html>
```

## 実装の詳細

### 1. 元のデータの保持

`HistogramSeries`クラスに、元のデータを保持するプロパティを追加します。

```javascript
class HistogramSeries {
    constructor(histogramChart, options = {}) {
        // ... 既存のコード ...
        this.data = []; // ビンに分類された頻度データ
        this.rawData = []; // 元のデータ値の配列（追加）
        this.binDataMap = new Map(); // ビンインデックス -> 元のデータ配列のマッピング（追加）
    }
}
```

### 2. ビンとデータのマッピング

TSVローダーでデータを読み込む際に、各ビンに含まれる元のデータを記録します。

```javascript
// HistogramTSVLoaderのload()メソッド内
for (const value of rawData) {
    // ビンに分類
    const binIndex = calculateBinIndex(value, bins);
    
    // 頻度をカウント
    frequencies[binIndex]++;
    
    // 元のデータを記録
    if (!binDataMap.has(binIndex)) {
        binDataMap.set(binIndex, []);
    }
    binDataMap.get(binIndex).push(value);
}
```

### 3. クリックイベントの実装

ヒストグラムを描画する際に、各棒（`<rect>`要素）にクリックイベントリスナーを追加します。

```javascript
// ヒストグラムの描画処理内
rect.addEventListener('click', (event) => {
    const binIndex = /* クリックされたビンのインデックス */;
    const dataArray = this.series[0].binDataMap.get(binIndex) || [];
    
    if (this.onBinClick) {
        this.onBinClick(dataArray);
    }
});
```

### 4. 複数系列の場合

複数の系列がある場合（グループ別ヒストグラム）、クリックされた系列を特定する必要があります。

```javascript
// 各系列の棒に、系列インデックスを記録
rect.setAttribute('data-series-index', seriesIndex);
rect.setAttribute('data-bin-index', binIndex);

// クリックイベントで系列を特定
rect.addEventListener('click', (event) => {
    const seriesIndex = parseInt(event.target.getAttribute('data-series-index'));
    const binIndex = parseInt(event.target.getAttribute('data-bin-index'));
    const series = this.series[seriesIndex];
    const dataArray = series.binDataMap.get(binIndex) || [];
    
    if (this.onBinClick) {
        this.onBinClick(dataArray, {
            seriesIndex: seriesIndex,
            seriesTitle: series.title,
            binIndex: binIndex,
            binRange: { min: bins[binIndex], max: bins[binIndex + 1] }
        });
    }
});
```

## 使用例

### 例1: 基本的な使用

```javascript
histogram.onBinClick = function(dataArray) {
    console.log('クリックされたビンのデータ:', dataArray);
    displayDataTable(dataArray, 'data_table_div');
};
```

### 例2: 統計情報も表示

```javascript
histogram.onBinClick = function(dataArray) {
    const count = dataArray.length;
    const sum = dataArray.reduce((a, b) => a + b, 0);
    const avg = sum / count;
    const min = Math.min(...dataArray);
    const max = Math.max(...dataArray);
    
    console.log(`件数: ${count}, 合計: ${sum}, 平均: ${avg}, 最小: ${min}, 最大: ${max}`);
    displayDataTable(dataArray, 'data_table_div');
};
```

### 例3: JSON形式でデータを送信

```javascript
histogram.onBinClick = function(dataArray) {
    const jsonData = {
        count: dataArray.length,
        values: dataArray,
        statistics: {
            sum: dataArray.reduce((a, b) => a + b, 0),
            average: dataArray.reduce((a, b) => a + b, 0) / dataArray.length,
            min: Math.min(...dataArray),
            max: Math.max(...dataArray)
        }
    };
    
    displayDataTable(jsonData, 'data_table_div');
};
```

## テーブル表示関数の拡張

### JSONデータを受け取る形式

```javascript
function displayDataTable(jsonData, containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container element not found: ${containerId}`);
        return;
    }
    
    // JSONデータが配列の場合
    if (Array.isArray(jsonData)) {
        // 配列をテーブルに変換
        // ... (上記の実装)
    }
    // JSONデータがオブジェクトの場合
    else if (typeof jsonData === 'object' && jsonData !== null) {
        // オブジェクトの構造に応じてテーブルを生成
        const table = document.createElement('table');
        table.className = 'data-table';
        
        // ヘッダー行
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        // キーをヘッダーに追加
        Object.keys(jsonData.values[0] || {}).forEach(key => {
            const headerCell = document.createElement('th');
            headerCell.textContent = key;
            headerRow.appendChild(headerCell);
        });
        
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // データ行
        const tbody = document.createElement('tbody');
        jsonData.values.forEach(item => {
            const row = document.createElement('tr');
            Object.values(item).forEach(value => {
                const cell = document.createElement('td');
                cell.textContent = value;
                row.appendChild(cell);
            });
            tbody.appendChild(row);
        });
        table.appendChild(tbody);
        
        container.innerHTML = '';
        container.appendChild(table);
    }
}
```

## エラーハンドリング

### コールバック関数が指定されていない場合

- クリックイベントは無視される（エラーをスローしない）
- デフォルトの動作（ツールチップ表示など）は継続

### データが存在しない場合

- `dataArray`が空配列の場合、コールバック関数は空配列を渡す
- テーブル表示関数で適切に処理（「データがありません」などのメッセージを表示）

### コンテナ要素が見つからない場合

- コンソールにエラーメッセージを出力
- エラーをスローせず、処理を続行

## 関連ドキュメント

- [08-API仕様.md](./08-API仕様.md) - HistogramChartクラスのAPI仕様
- [14-棒グラフの使い方.md](./14-棒グラフの使い方.md) - ヒストグラムの使い方
- [20-002.html仕様（TSVローダーAPI）.md](./20-002.html仕様（TSVローダーAPI）.md) - TSVローダーAPI仕様

