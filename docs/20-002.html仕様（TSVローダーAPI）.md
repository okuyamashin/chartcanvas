# 002.html仕様（TSVローダーAPI）

## 概要

002.htmlのAPI仕様で、TSVファイルを読み込んで自動的にグラフを生成する機能を定義します。

## API仕様

### TSVローダーの作成

`DateChart`オブジェクトに対して、`tsvLoader()`メソッドを呼び出してTSVローダーを作成します。

```javascript
const loader = dateChart.tsvLoader('https://sample.com/data.tsv');
```

**パラメータ:**
- `url` (string): TSVファイルのURL

**戻り値:**
- `TsvLoader`オブジェクト

### 列のマッピング設定

TSVファイルのヘッダー行にある列名を、日付、値、グループに対応付けます。

```javascript
loader.dateTitle = '日付';      // 日付列の列名
loader.valueTitle = '売上';     // 値列の列名
loader.groupTitle = '店舗名';    // グループ列の列名
```

**プロパティ:**
- `dateTitle` (string): 日付列の列名（必須）
- `valueTitle` (string): 値列の列名（必須）
- `groupTitle` (string): グループ列の列名（必須）

### データの読み込み

`load()`メソッドを呼び出して、TSVファイルを読み込み、データを解析してグラフに追加します。

```javascript
await loader.load();
```

**戻り値:**
- `Promise<void>`: 読み込みが完了したら解決されるPromise

**処理内容:**
1. TSVファイルをfetch APIで読み込む
2. ヘッダー行（1行目）を解析して、各列のインデックスを取得
3. データ行（2行目以降）を解析して、グループごとにデータを分類
4. 各グループに対して自動的に`addLine()`を呼び出し
5. 各グループのデータに対して`addData()`を呼び出してデータを追加
6. 線のスタイル（色など）を自動的に決定

## 使用例

```javascript
window.addEventListener('DOMContentLoaded', async () => {
    const chart_div = document.getElementById('chart_div');
    const chart = new ChartCanvas(chart_div);
    chart.size(1024, 600);
    
    const dateChart = chart.addDateChart();
    dateChart.xAxisTitle = '日付';
    dateChart.yAxisTitle = '売上';
    dateChart.yAxisScale = '万円';
    dateChart.yAxisFormat = '#,##0';
    dateChart.title = '売上推移';
    dateChart.subtitle = '2025/01/01 - 2025/01/09';

    const loader = dateChart.tsvLoader('https://sample.com/data.tsv');
    loader.dateTitle = '日付';
    loader.valueTitle = '売上';
    loader.groupTitle = '店舗名';

    try {
        await loader.load();
        chart.render();
    } catch (error) {
        console.error('TSVファイルの読み込みエラー:', error);
        chart.render();
    }
});
```

## TSVファイルの形式

### ヘッダー行

TSVファイルの1行目はヘッダー行として扱われます。タブ区切りで列名を記述します。

```
日付	売上	店舗名
```

### データ行

2行目以降がデータ行として扱われます。タブ区切りでデータを記述します。

```
20250101	20000	新宿店
20250102	21000	新宿店
20250101	15000	渋谷店
20250102	16000	渋谷店
```

### データ形式

- **日付列**: 日付を文字列で記述（例: `20250101`, `2025/01/01`）
- **値列**: 数値を記述（例: `20000`, `15000`）
- **グループ列**: グループ名を文字列で記述（例: `新宿店`, `渋谷店`）

## 処理フロー

### 1. TSVファイルの読み込み

`loader.load()`が呼ばれると、以下の処理が実行されます：

1. **fetch APIでTSVファイルを読み込む**
   - `fetch(url)`でTSVファイルを取得
   - `response.text()`でテキストデータを取得

2. **ヘッダー行の解析**
   - 1行目をタブ区切りで分割
   - `dateTitle`, `valueTitle`, `groupTitle`に対応する列のインデックスを取得
   - 列が見つからない場合はエラーをスロー

3. **データ行の解析**
   - 2行目以降を1行ずつ処理
   - タブ区切りで分割して、日付、値、グループを取得
   - グループごとにデータを分類（`Map`を使用）

4. **データのソート**
   - 各グループのデータを日付でソート

5. **系列の自動追加**
   - 各グループに対して`addLine()`を呼び出し
   - 線のスタイル（色など）を自動的に決定
   - 各グループのデータに対して`addData()`を呼び出してデータを追加

### 2. グラフの描画

`loader.load()`が完了したら、`chart.render()`を呼び出してグラフを描画します。

## 自動処理の詳細

### グループごとの系列追加

- 新しいグループが出現したら、自動的に`addLine()`を呼び出します
- グループ名が系列のタイトルとして使用されます

### 線のスタイルの自動決定

- 色は自動的に割り当てられます（例: `red`, `blue`, `green`, `orange`, `purple`など）
- 各グループに異なる色が割り当てられます
- グループ数が色の数より多い場合、色が循環して使用されます

### データの追加

- 各グループのデータは、日付でソートされた後に`addData()`で追加されます
- 日付の形式は、TSVファイルに記述された形式のまま使用されます

## エラーハンドリング

### ファイル読み込みエラー

- HTTPエラー（404、500など）が発生した場合、`load()`メソッドがエラーをスローします
- エラー時は`catch`ブロックで処理し、エラーメッセージをコンソールに出力します
- エラー時も`chart.render()`を呼び出して、空のグラフを表示します

### データ形式エラー

- ヘッダー行に必要な列が見つからない場合、エラーをスローします
- データ行の列数が足りない場合、その行はスキップされます
- 値列が数値でない場合、その行はスキップされます

## 実装時の注意点

### 1. 非同期処理

- `load()`メソッドは非同期で実行されるため、`await`で待機する必要があります
- `chart.render()`は、`load()`が完了してから呼び出す必要があります

### 2. データの順序

- TSVファイルのデータ行の順序は保持されません
- 各グループのデータは、日付でソートされた後に追加されます

### 3. 日付形式

- 日付の形式は、TSVファイルに記述された形式のまま使用されます
- 日付の形式が統一されていない場合、ソートが正しく動作しない可能性があります

### 4. グループ名の重複

- 同じグループ名のデータは、同じ系列に追加されます
- グループ名が空文字列の場合も、1つのグループとして扱われます

## 関連ドキュメント

- [18-001.html仕様の評価.md](./18-001.html仕様の評価.md) - 001.htmlのAPI仕様の評価
- [19-レンダリング処理フロー.md](./19-レンダリング処理フロー.md) - レンダリング処理のフロー
- [02-機能要件.md](./02-機能要件.md) - データ入力方法の要件

## 将来の拡張

### CSVローダー

TSVローダーと同様に、CSVローダーも実装可能です：

```javascript
const loader = dateChart.csvLoader('https://sample.com/data.csv');
```

### JSONローダー

JSON形式のデータを読み込むローダーも実装可能です：

```javascript
const loader = dateChart.jsonLoader('https://sample.com/data.json');
loader.datePath = 'date';
loader.valuePath = 'value';
loader.groupPath = 'store';
```

### カスタマイズオプション

線のスタイルをカスタマイズするオプションを追加することも可能です：

```javascript
loader.colorPalette = ['red', 'blue', 'green']; // 色のパレットを指定
loader.lineWidth = 2; // 線の太さを指定
loader.lineType = 'solid'; // 線の種類を指定
```

