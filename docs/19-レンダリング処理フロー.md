# レンダリング処理フロー

## 概要

001.htmlのサンプルコードに基づき、グラフのレンダリング処理のフローを定義します。

## 処理の流れ

### 1. データの取り込み

ユーザーは、グラフを作成する前に、以下の手順でデータを追加します：

```javascript
const chart = new ChartCanvas(chart_div);
const dateChart = chart.addDateChart();

// 系列を追加
const firstLine = dateChart.addLine({ title: '売上', color: 'red' });

// データを追加
firstLine.addData('20250101', 20000);
firstLine.addData('20250102', 21000);
// ... データを順次追加

// 最後にrender()を呼び出す
chart.render();
```

**重要なポイント:**
- データは`render()`が呼ばれる前にすべて追加される
- `render()`が呼ばれる時点で、すべてのデータが利用可能な状態になっている

### 2. render()メソッドの処理フロー

`chart.render()`が呼ばれると、以下の順序で処理が実行されます：

#### ステップ1: データのサマリ取得

**目的:** すべての系列からデータを収集し、グラフの描画に必要な情報を集約する

**処理内容:**
1. すべてのチャート（`DateChart`など）を走査
2. 各チャートのすべての系列（`Line`、`Bar`など）を走査
3. 各系列のデータを収集し、以下の情報を計算：
   - **X軸の範囲:**
     - 日付チャートの場合: 最初の日付と最後の日付を取得
     - カテゴリチャートの場合: すべてのカテゴリを取得
   - **Y軸の範囲:**
     - 各系列の値の最小値と最大値を取得
     - 主軸（primary axis）と副軸（second axis）を分けて計算
   - **系列の情報:**
     - 系列の数、タイトル、色、線の種類など

**例:**
```javascript
// データのサマリ例
{
  xAxis: {
    type: 'date',
    min: '20250101',
    max: '20250109',
    labels: ['20250101', '20250102', ..., '20250109']
  },
  yAxis: {
    primary: {
      min: 20000,
      max: 27000,
      scale: '万円',
      format: '#,##0'
    },
    secondary: {
      min: 0,
      max: 100,
      scale: '%',
      format: '#,##0%',
      enabled: true
    }
  },
  series: [
    { type: 'line', title: '売上', color: 'red', data: [...] },
    { type: 'bar', title: '売上構成比', color: 'blue', secondAxis: true, data: [...] }
  ]
}
```

#### ステップ2: ラベルとスケールの決定

**目的:** データのサマリに基づいて、X軸・Y軸のラベルとスケールを決定する

**処理内容:**

##### 2-1. X軸ラベルの決定

- **日付チャートの場合:**
  - 日付範囲に応じて、表示形式を決定（例: `2025/01/01`、`01/01`など）
  - ラベルが多すぎる場合、自動的に間引く
  - 階層表示の場合は、年/月/日の階層を決定

- **カテゴリチャートの場合:**
  - すべてのカテゴリ名をラベルとして使用
  - カテゴリ名が長すぎる場合、省略または回転を検討

##### 2-2. Y軸ラベルの決定

- **主軸（primary axis）の場合:**
  - データの最小値と最大値に基づいて、スケールを決定
  - 最小値が0以上の場合: ゼロベース（0から始める）
  - 最小値が0未満の場合: 最小値から始める
  - ラベル間隔を自動計算:
    - パーセンテージの場合: 10%刻み（0%, 10%, 20%, ..., 100%）
    - 通常の数値の場合:
      - 範囲が30以下の場合: 1刻み
      - 範囲が30超の場合: 10の倍数で間隔を調整
      - ラベル数が30個以下になるように自動調整

- **副軸（second axis）の場合:**
  - 副軸が有効な場合、同様の処理を副軸用のデータに対して実行

**例:**
```javascript
// Y軸ラベルの決定例
// データ範囲: 20000 〜 27000
// → Y軸ラベル: 0, 5000, 10000, 15000, 20000, 25000, 30000（5000刻み）

// パーセンテージの場合: データ範囲 0 〜 100
// → Y軸ラベル: 0%, 10%, 20%, 30%, ..., 100%（10%刻み）
```

##### 2-3. グラフエリアのサイズ決定

- タイトル、サブタイトル、X軸ラベル、Y軸ラベル、凡例のサイズを計算
- グラフの描画エリア（実際に線や棒を描く領域）のサイズを決定
- Y軸ラベルの最大文字長と凡例の文字長に基づいて、左右のマージンを調整

#### ステップ3: 順番に描画

データのサマリとラベル・スケールが決定されたら、以下の順序で描画を実行します：

##### 3-1. 背景とグリッドの描画

- グラフエリアの背景を描画
- グリッド線（縦線・横線）を描画
- グリッド線はY軸ラベルの位置に合わせて描画

##### 3-2. X軸・Y軸の描画

- X軸の線とラベルを描画
- Y軸の線とラベルを描画
- 軸のタイトルを描画

##### 3-3. 系列の描画

各系列を順番に描画します：

- **折れ線グラフ（Line）の場合:**
  1. 各データポイントの座標を計算
  2. データポイントを線で結ぶ
  3. 必要に応じてマーカーを描画

- **棒グラフ（Bar）の場合:**
  1. 各データポイントの座標を計算
  2. 各データポイントに棒を描画
  3. 必要に応じてラベルを描画

- **複数の系列がある場合:**
  - 各系列を順番に描画（後から描画した系列が上に表示される）

##### 3-4. 凡例の描画

- すべての系列の情報を収集
- 凡例をグラフの右側に描画
- 各系列の色とタイトルを表示
- タイトルが20字以上の場合は省略

##### 3-5. タイトルとサブタイトルの描画

- グラフのタイトルを描画
- サブタイトル（日付範囲など）を描画

##### 3-6. ツールチップの準備

- 各データポイントにツールチップのイベントリスナーを設定
- マウスオーバー時にツールチップを表示する準備

## 処理フローの図

```
chart.render()
  │
  ├─→ ステップ1: データのサマリ取得
  │     ├─ すべてのチャートを走査
  │     ├─ すべての系列を走査
  │     ├─ X軸の範囲を計算
  │     └─ Y軸の範囲を計算（主軸・副軸）
  │
  ├─→ ステップ2: ラベルとスケールの決定
  │     ├─ X軸ラベルの決定
  │     ├─ Y軸ラベルの決定（主軸）
  │     ├─ Y軸ラベルの決定（副軸、有効な場合）
  │     └─ グラフエリアのサイズ決定
  │
  └─→ ステップ3: 順番に描画
        ├─ 背景とグリッドの描画
        ├─ X軸・Y軸の描画
        ├─ 系列の描画（順番に）
        ├─ 凡例の描画
        ├─ タイトルとサブタイトルの描画
        └─ ツールチップの準備
```

## 重要な設計原則

### 1. データのサマリを先に取得する

**理由:**
- すべてのデータを把握してから、適切なスケールとラベルを決定できる
- 複数の系列がある場合でも、全体の範囲を考慮したスケールを設定できる
- 副軸がある場合、主軸と副軸の両方のスケールを適切に設定できる

### 2. ラベルとスケールを先に決定する

**理由:**
- グラフエリアのサイズを正確に計算できる
- ラベルの文字数に応じて、マージンを調整できる
- 描画の順序を最適化できる

### 3. 順番に描画する

**理由:**
- 背景 → グリッド → 軸 → 系列 → 凡例 → タイトル の順序で描画することで、正しい重ね順を保証できる
- 各要素が適切な位置に配置される

## 実装時の注意点

### 1. データの収集タイミング

- `render()`が呼ばれる時点で、すべてのデータが追加されていることを前提とする
- `render()`の呼び出し後にデータを追加しても、反映されない

### 2. パフォーマンス

- 大量のデータがある場合、サマリの取得とラベルの計算を効率的に行う
- 不要な再計算を避けるため、一度計算した結果をキャッシュする

### 3. エラーハンドリング

- データが空の場合の処理
- データの形式が不正な場合の処理
- スケールの計算でエラーが発生した場合の処理

## 関連ドキュメント

- [02-機能要件.md](./02-機能要件.md) - Y軸のスケールとラベルの仕様
- [12-Y軸設計.md](./12-Y軸設計.md) - Y軸の設計詳細
- [10-ラベル設計.md](./10-ラベル設計.md) - ラベルの設計詳細
- [18-001.html仕様の評価.md](./18-001.html仕様の評価.md) - 001.htmlのAPI仕様の評価

