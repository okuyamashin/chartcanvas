# ラベル設計

## ラベルの重要性

**グラフを考える上で非常に大事なのはグラフの線ではなく、実はラベルです。**

- ラベルがないとグラフの意味が伝わらない
- データの線や棒よりも、ラベルの方が情報量が多い
- 読みやすさに大きく影響する
- SVG出力時もラベルが適切に表示される必要がある

## ラベルの種類

### 1. X軸ラベル（カテゴリラベル）
- 横軸に表示されるラベル
- 例: `['1月', '2月', '3月', '4月', '5月']`
- データポイントごとに表示される

### 2. Y軸ラベル（値ラベル）
- 縦軸に表示される値のラベル
- 例: `0, 50, 100, 150, 200`
- 通常は自動生成されるが、カスタマイズ可能

### 3. 軸タイトル
- X軸の説明（例: "月"）
- Y軸の説明（例: "売上（万円）"）
- グラフの意味を明確にするために重要

### 4. グラフタイトル
- グラフ全体のタイトル
- 例: "2024年売上推移"

### 4-1. グラフサブタイトル
- グラフタイトルの下に表示される補足情報
- 例: "2024/01/01 - 2024/12/31"（日付範囲など）
- タイトルとサブタイトルの組み合わせで、より詳細な情報を提供

### 5. データポイントラベル
- 各データポイントの値を表示
- 例: 折れ線グラフの各点に値を表示

### 6. 凡例（Legend）
- 複数の系列がある場合の説明
- 例: "売上A", "売上B" など
- **配置:** グラフの右側に配置（一般的な配置方法）
  - Chart.jsはタイトルとグラフの間に凡例を配置する独特の形式だが、本プロジェクトでは右側配置を採用
  - 右側配置の方が一般的で、グラフエリアを広く使える

### 7. 円グラフのラベル（Pie Chart Labels）
- 円グラフ特有のラベル表示
- 各セグメント（扇形）に直接ラベルを表示
- ラベルの種類:
  - カテゴリ名（例: "商品A"）
  - 値（例: "100"）
  - パーセンテージ（例: "25%"）
  - または、組み合わせ（例: "商品A: 100 (25%)"）

## ラベルの設計方針

### 必須機能として優先度を高く設定

ラベルは以下の理由で、グラフの線よりも優先度が高い：

1. **情報伝達の核心**
   - ラベルがないと、データの意味が分からない
   - グラフの線だけでは、何を表しているか不明確

2. **可読性の基盤**
   - フォントサイズ、配置、回転などが重要
   - ラベルが適切でないと、グラフが読みにくくなる

3. **SVG出力時の品質**
   - SVGファイルとして出力する際も、ラベルが適切に表示される必要がある
   - ラベルの位置やサイズが適切でないと、出力品質が低下する

### ラベルの設定方法（要検討）

#### 案1: 各グラフタイプで個別に設定
```javascript
const lineChart = chart.addLineChart();
lineChart.setXLabels(['1月', '2月', '3月']);
lineChart.setXAxisTitle('月');
lineChart.setYAxisTitle('売上（万円）');
lineChart.setTitle('2024年売上推移');
```

#### 案2: ChartCanvasレベルで設定
```javascript
chart.setXLabels(['1月', '2月', '3月']);
chart.setXAxisTitle('月');
chart.setYAxisTitle('売上（万円）');
chart.setTitle('2024年売上推移');
```

#### 案3: オプションオブジェクトで一括設定
```javascript
const lineChart = chart.addLineChart();
lineChart.setLabels({
    x: ['1月', '2月', '3月'],
    xAxisTitle: '月',
    yAxisTitle: '売上（万円）',
    title: '2024年売上推移'
});
```

## ラベルのスタイリング

### フォントサイズ
- デフォルトサイズを適切に設定
- カスタマイズ可能にする

### フォントファミリー
- デフォルトフォントを設定
- 日本語対応が重要

### ラベルの配置
- X軸ラベル: データポイントの下に配置
- Y軸ラベル: 軸の左側に配置
- タイトル: グラフの上部に配置
- **凡例: グラフの右側に配置**
  - 複数の系列がある場合、グラフの右側に凡例を表示
  - Chart.jsのようにタイトルとグラフの間に配置するのではなく、一般的な右側配置を採用
  - グラフエリアを広く使えるため、データの可読性が向上

### ラベルの回転
- X軸ラベルが長い場合、回転して表示
- 例: 45度、90度回転
- **ただし:** 縦書きは読みづらいため、階層的な表示を優先する

### ラベルの間引き（重要・必須機能）

**X軸ラベルが多すぎる場合、自動的に間引いて表示する必要があります。**

#### 問題例
- 1年分の日付（365個）をX軸に表示すると、文字がゴチャゴチャになる
- すべてのラベルを表示すると、読み取れなくなる

#### Chart.jsの動作
- Chart.jsは自動的に適切な間隔でラベルを間引いて表示する
- 例: 365個の日付のうち、適切な間隔（例: 月ごと、週ごと）で表示

#### 実装方針
1. **自動間引きアルゴリズム**
   - 利用可能な幅とラベルの文字幅を計算
   - ラベルが重ならないように、適切な間隔で表示
   - 例: 365個のラベルのうち、表示可能な数だけ自動的に選択

2. **間引きの基準**
   - ラベルの文字幅を考慮
   - グラフの幅を考慮
   - 最小間隔を設定（例: ラベル間は最低50px）

3. **間引きの方法**
   - 均等に間引く（例: 10個ごとに1個表示）
   - または、意味のある単位で間引く（日付の場合: 月ごと、週ごと）

4. **カスタマイズ**
   - デフォルトは自動間引き
   - オプションで間引きを無効化可能
   - オプションで間引きの間隔を指定可能

### 日付ラベルの階層表示（重要・必須機能）

**X軸ラベルが日付の場合、縦書きではなく階層的な表示を採用します。**

#### 問題: 縦書きは読みづらい
- X軸が狭い場合、ラベルを縦書き（90度回転）にすると読みづらい
- 縦書きの文字は読みにくく、ユーザビリティが低下する

#### 解決策: 階層的な表示
日付ラベルの場合、以下のような階層的な表示を行います：

**1年分の日付の場合:**
```
2024/01 02 03 04 05 06 07 08 09 10 11 12 2025/01 02
```

**1ヶ月分の日付の場合:**
```
2025/10/01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 ...
```

**構造:**
- **1年分の日付:**
  - **年を大きく表示**（例: `2024`）
  - **その年の月を横に並べて表示**（例: `01 02 03 04 05 06 07 08 09 10 11 12`）
  - **次の年があれば、また年を表示して月を並べる**（例: `2025/01 02`）

- **1ヶ月分の日付:**
  - **年/月を大きく表示**（例: `2025/10`）
  - **その月の日を横に並べて表示**（例: `01 02 03 04 05 06 07 08 09 10 11 12 ...`）
  - **次の月があれば、また年/月を表示して日を並べる**

#### 実装方針

1. **日付ラベルの自動検出**
   - ラベルが日付形式（YYYY/MM/DD、YYYY-MM-DDなど）かどうかを自動検出
   - または、ユーザーが明示的に日付ラベルであることを指定

2. **階層構造の生成**
   - 日付ラベルを解析して、年・月・日を抽出
   - **1年分の日付の場合:** 同じ年の月をグループ化（年→月の階層）
   - **1ヶ月分の日付の場合:** 同じ年/月の日をグループ化（年/月→日の階層）
   - 親ラベルと子ラベルとして配置

3. **表示レイアウト**
   - **1年分の日付:**
     - 年ラベル: その年の最初の月の位置に配置（通常のフォントサイズ）
     - 月ラベル: 各月の位置に横並びで配置（通常のフォントサイズ）
     - 2行構造: 1行目に年、2行目に月
   - **1ヶ月分の日付:**
     - 年/月ラベル: その月の最初の日の位置に配置（通常のフォントサイズ）
     - 日ラベル: 各日の位置に横並びで配置（通常のフォントサイズ）
     - 2行構造: 1行目に年/月、2行目に日
   - **3年分など長期間の日付:**
     - 最初の年/月だけ通常のフォントサイズ（例: `2020/01`）
     - 残りの月/日は小さなフォントサイズ（例: `02 03 04 05 06 07 08 09 10 11 12`）
     - スペースを節約しつつ、読みやすさを保つ

4. **表示例**
   - **1年分の日付:**
     ```
     2024/01 02 03 04 05 06 07 08 09 10 11 12 2025/01 02
     ```
     （すべて通常のフォントサイズ）
   
   - **1ヶ月分の日付:**
     ```
     2025/10/01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 ...
     ```
     （すべて通常のフォントサイズ）
   
   - **3年分など長期間の日付:**
     ```
     2020/01 02 03 04 05 06 07 08 09 10 11 12 2021/01 02 03 04 ...
     ```
     - `2020/01` は通常のフォントサイズ
     - `02 03 04 05 06 07 08 09 10 11 12` は小さなフォントサイズ
     - 次の年の `2021/01` は通常のフォントサイズ
     - 以降も同様に、最初の年/月だけ通常サイズ、残りは小さく

5. **フォントサイズの戦略**
   - **短期間（1年分、1ヶ月分）:** すべて通常のフォントサイズ
   - **長期間（3年分など）:** 
     - 最初の年/月だけ通常のフォントサイズ（例: `2020/01`）
     - 残りの月/日は小さなフォントサイズ（例: `02 03 04 05 06 07 08 09 10 11 12`）
     - 次の年の最初の月は再び通常サイズ（例: `2021/01`）
     - これにより、スペースを節約しつつ、重要な情報（年/月の区切り）は明確に表示
     - ラベルが被ることを防ぎ、読みやすさを保つ

6. **カスタマイズ**
   - 日付フォーマットの指定（例: YYYY/MM、YYYY-MM-DD）
   - 階層表示の有効/無効
   - 年の表示位置（最初の月の位置、中央など）
   - フォントサイズの比率（親ラベルと子ラベルのサイズ比）

### 凡例（Legend）の設計（重要）

**凡例は複数の系列がある場合に必須の機能です。**

#### 配置方法

**決定:** グラフの右側に配置（一般的な配置方法）

- **Chart.jsとの違い:**
  - Chart.jsはタイトルとグラフの間に凡例を配置する独特の形式
  - 本プロジェクトでは、一般的な右側配置を採用
  - 右側配置の方が標準的で、グラフエリアを広く使える

#### 配置位置のオプション

- **デフォルト: 右側（right）**
  - グラフの右側に縦に並べて表示
  - 最も一般的な配置方法

- **オプション: 上（top）、下（bottom）、左（left）**
  - ユーザーが配置位置を指定可能
  - 例: `setLegendPosition('top')` または `setLegendPosition('bottom')`

#### 凡例の表示内容

- **各系列の情報:**
  - 系列の色（線の色、棒の色など）
  - 系列のラベル（例: "売上A", "売上B"）
  - 系列のアイコン（線、マーカー、棒など）

#### 凡例の自動表示

- **複数の系列がある場合:**
  - 自動的に凡例を表示
  - 各系列の色とラベルを自動的に設定

- **単一の系列の場合:**
  - 凡例は表示しない（オプションで表示可能）

#### 凡例のスタイリング

- **フォントサイズ:**
  - デフォルトサイズを適切に設定
  - カスタマイズ可能

- **凡例の間隔:**
  - 各凡例項目間の間隔
  - デフォルト: 適切な間隔（例: 10px）

- **凡例のアイコン:**
  - 線グラフ: 線のサンプル
  - 棒グラフ: 棒のサンプル
  - アイコンのサイズを調整可能

#### 凡例の幅の問題と解決策（重要）

**問題:** 凡例に文字列が含まれるため、文字列の長さによってグラフの横幅が圧迫される可能性がある

特に日本語の長いラベルがある場合、凡例が広くなりすぎてグラフエリアが狭くなってしまう。

**解決策:**

1. **凡例の最大幅を設定**
   - 凡例の最大幅を制限する（例: グラフ幅の20%以下）
   - グラフエリアの幅を確保するため、凡例の幅を制限
   - デフォルト: グラフ幅の20%以下、または最大200px

2. **文字列の省略表示**
   - 凡例の文字列が長い場合、省略記号（...）で表示
   - 例: "非常に長いラベル名..." → "非常に長いラベル..."
   - 最大文字数を設定（例: 10文字、または最大幅に収まる文字数）

3. **文字列の折り返し**
   - 凡例の文字列を複数行に折り返す
   - ただし、凡例が縦に長くなりすぎないように注意

4. **グラフエリアの幅の確保**
   - 凡例の幅を制限することで、グラフエリアの幅を確保
   - グラフエリアの最小幅を設定（例: グラフ幅の70%以上）

5. **フォントサイズの調整**
   - 凡例のフォントサイズを調整して、幅を抑える
   - ただし、可読性を保つ必要がある

**採用方針:**

- **デフォルト:** 凡例の最大幅をグラフ幅の20%以下に制限
- **文字列が長い場合:** 20字以上は省略記号（...）で表示
  - 例: "非常に長いラベル名が20字以上ある場合..." → "非常に長いラベル名が20字以上..."
- **グラフエリアの確保:** グラフ描画エリアの最小幅をグラフ幅の50%以上に設定（動的調整の場合）
- **オプション:** ユーザーが凡例の最大幅や文字列の最大長をカスタマイズ可能

#### グラフ描画エリアの動的な幅調整（重要）

**決定:** Y軸ラベルの文字長と凡例の文字長によって、グラフの描画エリア（幅）が動的に変化する

- **Y軸ラベルの文字長:**
  - Y軸ラベルの最大文字長を計算
  - 例: "1,000,000" のような長い数値の場合、Y軸ラベルの幅が広くなる
  - Y軸ラベルの幅に応じて、グラフ描画エリアの左側のマージンを調整

- **凡例の文字長:**
  - 凡例のラベルの最大文字長を計算（20字以上は省略）
  - 凡例の幅に応じて、グラフ描画エリアの右側のマージンを調整

- **グラフ描画エリアの幅の計算:**
  ```
  グラフ描画エリアの幅 = グラフ全体の幅 - Y軸ラベルの幅 - 凡例の幅 - その他のマージン
  ```

- **動的な調整:**
  - Y軸ラベルや凡例の文字が長い場合、自動的にグラフ描画エリアの幅を調整
  - グラフ描画エリアの最小幅を確保（グラフ幅の50%以上）

#### グラフの高さの動的な調整

**決定:** 高さは比較的固定だが、タイトルとX軸ラベルの文字の大きさで変化する

- **タイトルの高さ:**
  - タイトルとサブタイトルの行数に応じて高さを調整
  - タイトルが1行の場合と2行（タイトル+サブタイトル）の場合で高さが変わる

- **X軸ラベルの高さ:**
  - X軸ラベルの行数に応じて高さを調整
  - 日付ラベルの階層表示の場合、2行になるため高さが増える

- **グラフ描画エリアの高さの計算:**
  ```
  グラフ描画エリアの高さ = グラフ全体の高さ - タイトル領域の高さ - X軸ラベル領域の高さ - その他のマージン
  ```

#### 使用例

```javascript
// 複数の系列がある場合、自動的に凡例が表示される
const lineChart = chart.addLineChart();
lineChart.setData([
    [10, 20, 30, 40],  // 系列1: "系列1"
    [15, 25, 35, 45]   // 系列2: "系列2"
]);
// → 右側に凡例が自動表示: "系列1"（青線）、"系列2"（赤線）

// 凡例のラベルを指定
lineChart.setLegendLabels(['売上A', '売上B']);
// → 右側に凡例が表示: "売上A"（青線）、"売上B"（赤線）

// 凡例の配置位置を変更
lineChart.setLegendPosition('top');
// → 凡例がグラフの上部に表示

// 凡例を非表示
lineChart.setLegendVisible(false);

// 凡例の最大幅を設定（グラフエリアを圧迫しないように）
lineChart.setLegendMaxWidth(200);  // 最大200px
// または、グラフ幅の割合で指定
lineChart.setLegendMaxWidthPercent(20);  // グラフ幅の20%以下

// 凡例の文字列の最大長を設定（デフォルト: 20文字）
lineChart.setLegendMaxLabelLength(20);  // 最大20文字、それ以上は省略記号で表示
```

## 実装の優先順位

### Phase 1: 基本ラベル（最優先）
1. X軸ラベル（カテゴリラベル）
2. Y軸ラベル（値ラベル）
3. グラフタイトル
4. **グラフサブタイトル**（必須）
   - タイトルの下に表示される補足情報
   - 例: "2024/01/01 - 2024/12/31"

### Phase 2: 軸タイトル
1. X軸タイトル
2. Y軸タイトル

### Phase 5: 凡例（Legend）
1. **凡例の表示**
   - 複数の系列がある場合に自動表示
   - 各系列の色とラベルを表示
   - 例: "売上A"（青線）、"売上B"（赤線）など

2. **凡例の配置**
   - **デフォルト: グラフの右側に配置**
   - Chart.jsのようにタイトルとグラフの間に配置するのではなく、一般的な右側配置を採用
   - グラフエリアを広く使えるため、データの可読性が向上
   - オプションで配置位置を変更可能（上、下、左、右）

3. **凡例の幅の制限（重要）**
   - **凡例の最大幅を設定**（グラフエリアを圧迫しないように）
     - デフォルト: グラフ幅の20%以下、または最大200px
   - **文字列が長い場合の省略表示**
     - 凡例のラベルが長い場合、省略記号（...）で表示
     - 最大文字数を設定可能
   - **グラフエリアの幅の確保**
     - グラフエリアの最小幅をグラフ幅の70%以上に設定
     - 凡例の幅を制限することで、グラフエリアの幅を確保

4. **凡例のスタイリング**
   - 凡例のフォントサイズ
   - 凡例の間隔
   - 凡例のアイコン（線、マーカーなど）のサイズ
   - **凡例の文字列は20字以上は省略**（必須）

5. **グラフ描画エリアの動的な幅調整**（必須）
   - Y軸ラベルの文字長に応じて、左側のマージンを自動調整
   - 凡例の文字長（20字以上は省略）に応じて、右側のマージンを自動調整
   - グラフ描画エリアの最小幅: グラフ幅の50%以上

6. **グラフの高さの動的な調整**（必須）
   - タイトルとサブタイトルの行数に応じて、タイトル領域の高さを調整
   - X軸ラベルの行数（階層表示の場合は2行）に応じて、X軸ラベル領域の高さを調整

### Phase 6: 円グラフのラベル（Pie Chart Labels）

円グラフは他のグラフタイプとは異なる特性があるため、専用のラベル設計が必要です。

#### 円グラフのラベルの種類

1. **セグメントラベル（必須）**
   - 各セグメント（扇形）に表示されるラベル
   - カテゴリ名、値、パーセンテージを表示
   - 例: "商品A: 100 (25%)"

2. **ラベルの配置方法**

   円グラフのラベル表示には、主に2つのパターンがあります：

   **パターン1: 引出線（リーダーライン）を出すタイプ**
   - セグメントからリーダーライン（引き出し線）を伸ばしてラベルを表示
   - セグメントの外側にラベルを配置し、線で接続
   - メリット: 
     - 小さいセグメントでも読みやすい
     - どのセグメントに対応するか明確
   - デメリット: 
     - 実装が複雑
     - 見た目がやや複雑になる可能性
   - 使用例: セグメントが小さい場合、またはラベルが長い場合

   **パターン2: 外縁の円弧の中心に中央寄せでラベルを配置**
   - セグメントの外縁（円弧）の中心にラベルを配置
   - ラベルは中央寄せで表示
   - メリット: 
     - シンプルで見やすい
     - セグメントとラベルの対応が明確
     - 実装が比較的簡単
   - デメリット: 
     - セグメントが小さい場合、ラベルが読みにくい可能性
     - ラベルが重なる可能性
   - 使用例: セグメントが大きい場合、またはラベルが短い場合

   **案: セグメントのサイズに応じて自動選択（推奨）**
   - セグメントが大きい場合: 外縁の円弧の中心に中央寄せでラベルを配置（パターン2）
   - セグメントが小さい場合: 引出線（リーダーライン）を出すタイプ（パターン1）
   - メリット: 最適な表示方法を自動選択
   - デメリット: 実装が複雑

   **案: ユーザーが選択可能**
   - デフォルト: 自動選択
   - オプション: ユーザーが明示的にパターン1またはパターン2を選択可能

3. **小さいセグメントの処理**

   - **セグメントが小さい場合の判定:**
     - セグメントの角度が一定値（例: 5度）以下の場合、小さいと判定
     - または、セグメントの面積が一定値以下の場合

   - **小さいセグメントのラベル表示:**
     - セグメント外にリーダーラインで表示
     - または、凡例のみで表示（セグメント内のラベルは非表示）

4. **ラベルの内容**

   - **デフォルト:** カテゴリ名とパーセンテージ
     - 例: "商品A (25%)"
   
   - **オプション:** 値も含める
     - 例: "商品A: 100 (25%)"
   
   - **カスタマイズ:** ユーザーが表示内容を選択可能
     - カテゴリ名のみ
     - パーセンテージのみ
     - 値のみ
     - 組み合わせ

5. **凡例との関係**

   - **円グラフの場合、凡例は必須**
     - セグメントが小さい場合、ラベルが読みにくいため
     - 凡例で各セグメントの情報を確認できる
   
   - **凡例の配置:**
     - デフォルト: グラフの下に配置（円グラフの場合）
     - 複数の円グラフを並べる場合、各円グラフの下に凡例を配置
     - オプション: 右、上、左に配置可能

6. **複数の円グラフを並べる場合**

   - **1つの円グラフ:**
     - 単一表示
   
   - **2つの円グラフを横並び:**
     - 各円グラフの下に凡例を配置
     - 各円グラフのサイズは、グラフ全体の幅を2等分（マージンを除く）
   
   - **2つの円グラフを縦並び:**
     - 各円グラフの下に凡例を配置
     - 各円グラフのサイズは、グラフ全体の高さを2等分（マージンとタイトル領域を除く）
   
   - **3つの円グラフを横に3つ並べる:**
     - 各円グラフの下に凡例を配置
     - 各円グラフのサイズは、グラフ全体の幅を3等分（マージンを除く）
   
   - **4つの円グラフを2x2のグリッド状に配置（上下に2つずつ）:**
     - 各円グラフの下に凡例を配置
     - 各円グラフのサイズは、グラフ全体の幅と高さを2等分（マージンを除く）
   
   - **4つ以上は想定していません**（見づらくて使いにくいため）

7. **複数の円グラフのサイズ統一（重要）**

   - **全ての円グラフを同じサイズにする:**
     - ラベルの大きさ（タイトル、サブタイトル、凡例の文字数など）によって、各円グラフの描画エリアのサイズが変わる
     - 複数の円グラフを並べる場合、サイズがバラバラだと見づらい
     - **解決策:** 全ての円グラフの中で、一番小さな描画エリアのサイズに統一する
   
   - **サイズ計算の手順:**
     1. 各円グラフのラベル（タイトル、サブタイトル、凡例など）のサイズを計算
     2. ラベルのサイズに応じて、各円グラフの描画エリアのサイズを計算
     3. 全ての円グラフの中で、一番小さな描画エリアのサイズを特定
     4. 全ての円グラフを、一番小さなサイズに統一
   
   - **例:**
     - 円グラフ1: タイトルが短い → 描画エリアが大きい
     - 円グラフ2: タイトルが長い → 描画エリアが小さい
     - → 円グラフ1も円グラフ2と同じ小さなサイズに統一する

6. **ラベルの自動調整（重要）**

   **Chart.jsの課題:**
   - Chart.jsの円グラフは、ラベルの位置が手動設定になっており、自動的に調整できない
   - ラベルが重なったり、読みにくい位置に配置されたりする問題がある

   **円グラフのラベルの具体的な課題点:**
   - **180度付近（南）で文字が重なりやすい**
     - 円グラフの下部（180度付近）では、ラベルが縦に並ぶため重なりやすい
     - 特に複数のセグメントが下部に集中している場合、ラベルが重なって読みにくくなる
   
   - **350度付近（北西）で多くのデータが集まり「その他」にするのが普通**
     - 円グラフの左上（350度付近）では、多くの小さいセグメントが集まりやすい
     - 一般的な解決策として、小さいセグメントを「その他」カテゴリにまとめる
     - これにより、ラベルの数を減らし、見やすさが向上する

   **本プロジェクトでの解決方針:**
   - **ラベルの位置を自動的に調整する**（必須機能）
   - ユーザーが手動で位置を設定する必要がない

   - **180度付近（南）での重なり問題への対処:**
     - 180度付近のラベルは、特に注意して重なりを回避
     - ラベルの配置を少しずらす（角度を調整）
     - 引出線（リーダーライン）の長さを調整して、ラベルを離す
     - それでも重なる場合は、一部のラベルを非表示（凡例で確認可能）

   - **「その他」カテゴリのサポート:**
     - 小さいセグメントを自動的に「その他」カテゴリにまとめる機能
     - 閾値（例: 5%以下）を設定して、小さいセグメントを「その他」にまとめる
     - ユーザーが明示的に「その他」にまとめるセグメントを指定可能
     - 「その他」カテゴリは、350度付近（北西）に配置することを推奨

   - **ラベルが重なる場合の自動調整:**
     - ラベルの位置を自動的に調整して重なりを回避
     - 引出線（リーダーライン）の角度を調整
     - または、ラベルの配置を少しずらす
     - それでも重なる場合は、一部のラベルを非表示（凡例で確認可能）

   - **ラベルのフォントサイズ:**
     - セグメントのサイズに応じて自動調整
     - 小さいセグメントは小さめのフォントサイズ

   - **自動調整のアルゴリズム:**
     1. 各セグメントのラベルの位置を計算
     2. **180度付近（南）のラベルを特に注意してチェック**
     3. ラベル同士が重なっているかチェック
     4. 重なっている場合、位置を調整（角度を少しずらす、距離を調整するなど）
     5. **小さいセグメントを「その他」カテゴリにまとめる（オプション）**
     6. それでも重なる場合、優先度の低いラベルを非表示（凡例で確認可能）

#### 採用方針

**決定事項:**
- **ラベルの配置方法: セグメントのサイズに応じて自動選択**
  - セグメントが大きい場合: **外縁の円弧の中心に中央寄せでラベルを配置**（パターン2）
  - セグメントが小さい場合: **引出線（リーダーライン）を出すタイプ**（パターン1）
- **ユーザーが選択可能:**
  - デフォルト: 自動選択
  - オプション: ユーザーが明示的にパターン1またはパターン2を選択可能
- ラベルのデフォルト内容: カテゴリ名とパーセンテージ
- 凡例は必須（円グラフの場合）

**実装の詳細:**

- **外縁の円弧の中心にラベルを配置（パターン2）:**
  - セグメントの外縁（円弧）の中心角度を計算
  - その角度の位置にラベルを配置
  - ラベルは中央寄せで表示
  - ラベルが重なる場合は、位置を自動調整

- **引出線（リーダーライン）を出すタイプ（パターン1）:**
  - セグメントの外縁からリーダーラインを伸ばす
  - リーダーラインの先端にラベルを配置
  - リーダーラインのスタイル: 直線（推奨）
  - ラベルが重なる場合は、リーダーラインの角度を調整

**Chart.jsとの違い（重要）:**

- **Chart.jsの課題:**
  - 円グラフのラベルの位置が手動設定になっており、自動的に調整できない
  - ラベルが重なったり、読みにくい位置に配置されたりする問題がある

- **本プロジェクトでの解決方針:**
  - **ラベルの位置を自動的に調整する**（必須機能）
  - ラベルが重なる場合、自動的に位置を調整して重なりを回避
  - ユーザーが手動で位置を設定する必要がない
  - これにより、Chart.jsの課題を解決する

**検討事項:**
- セグメントが小さい場合の閾値（角度、面積など）
  - 例: セグメントの角度が5度以下の場合、パターン1（引出線）を使用
- ラベルの最小フォントサイズ
- リーダーラインのスタイル（直線、曲線など）
  - デフォルト: 直線
- ラベルが重なる場合の自動調整アルゴリズム
  - ラベルの位置を少しずらす
  - 引出線の角度を調整
  - 優先度の低いラベルを非表示

### Phase 7: その他のラベル
1. データポイントラベル（線グラフ、棒グラフの各点に値を表示）

### Phase 3: ラベルの自動間引き（必須）
1. **X軸ラベルの自動間引きアルゴリズム**
   - ラベルの数とグラフの幅を考慮
   - ラベルが重ならないように自動的に間引く
   - Chart.jsと同様の動作
   - **重要:** 1年分の日付など、大量のラベルに対応

### Phase 3.5: 日付ラベルの階層表示（必須）
1. **日付ラベルの自動検出**
   - ラベルが日付形式かどうかを自動検出
   - または、ユーザーが明示的に指定

2. **階層構造の生成**
   - 年と月を抽出してグループ化
   - 年を親ラベル、月を子ラベルとして配置

3. **階層的な表示レイアウト**
   - **1年分の日付:** 年ラベルと月ラベルを2行構造で表示
     - 例: `2024/01 02 03 04 05 06 07 08 09 10 11 12 2025/01 02`
     - すべて通常のフォントサイズ
   - **1ヶ月分の日付:** 年/月ラベルと日ラベルを2行構造で表示
     - 例: `2025/10/01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 ...`
     - すべて通常のフォントサイズ
   - **3年分など長期間の日付:**
     - 最初の年/月だけ通常のフォントサイズ（例: `2020/01`）
     - 残りの月/日は小さなフォントサイズ（例: `02 03 04 05 06 07 08 09 10 11 12`）
     - 次の年の最初の月は再び通常サイズ（例: `2021/01`）
     - ラベルが被ることを防ぎ、スペースを節約
   - **重要:** 縦書きではなく、横書きの階層表示で読みやすくする

### Phase 4: ラベルのスタイリング
1. フォントサイズのカスタマイズ
2. フォントファミリーのカスタマイズ
3. ラベルの回転
4. 間引きのカスタマイズ（オプション）

## 注意事項

- **ラベルは必須機能として扱う**
  - グラフの線よりも優先度が高い
  - ラベルなしのグラフは意味をなさない

- **日本語対応が重要**
  - 日本語のラベルが適切に表示される必要がある
  - フォントの選択が重要

- **SVG出力時の品質**
  - ラベルが適切にSVGに含まれる必要がある
  - フォントの埋め込みや、テキストの位置が正確である必要がある

